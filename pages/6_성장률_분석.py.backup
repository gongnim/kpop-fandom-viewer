"""
ì„±ì¥ë¥  ë¶„ì„ í˜ì´ì§€
================

K-Pop ì•„í‹°ìŠ¤íŠ¸ ë° ê·¸ë£¹ì˜ ì„±ì¥ë¥ ì„ ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ë¶„ì„í•˜ê³  ì‹œê°í™”í•˜ëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.
- í”Œë«í¼ë³„ ì„±ì¥ë¥  ë¹„êµ
- ì‹œê°„ëŒ€ë³„ ì„±ì¥ íŒ¨í„´ ë¶„ì„
- í†µê³„ì  ìœ ì˜ì„± ê²€ì¦
- ë°˜ì‘í˜• ì°¨íŠ¸ ë° ëŒ€ì‹œë³´ë“œ

Author: Frontend Development Team
Date: 2025-09-09
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from datetime import datetime, timedelta
import numpy as np
from typing import Dict, List, Any, Optional

# Import internal modules
try:
    from database_postgresql import get_all_artists_with_details, get_platform_metrics_history, get_companies
    from analytics.growth_rate_calculator import GrowthRateCalculator, CalculationMethod, GrowthPeriod, MetricDataPoint
    from utils.navigation import navigate_to
    from assets.responsive_styles import get_responsive_css, PageStyles
except ImportError as e:
    st.error(f"ëª¨ë“ˆ import ì˜¤ë¥˜: {e}")
    # ê°œë°œ ì¤‘ì—ëŠ” ì—ëŸ¬ë¥¼ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰

# Page configuration
st.set_page_config(
    page_title="ì„±ì¥ë¥  ë¶„ì„",
    page_icon="ğŸ“ˆ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Apply responsive styles
try:
    st.markdown(get_responsive_css(), unsafe_allow_html=True)
    st.markdown(f"<style>{PageStyles.growth_analysis()}</style>", unsafe_allow_html=True)
except:
    # Fallback styles if responsive_styles module is not available
    st.markdown("""
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.5rem;
            border-radius: 10px;
            color: white;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .growth-positive { color: #4CAF50; font-weight: bold; }
        .growth-negative { color: #f44336; font-weight: bold; }
        .growth-neutral { color: #FF9800; font-weight: bold; }
        @media (max-width: 768px) {
            .metric-card { padding: 1rem; font-size: 0.9rem; }
        }
    </style>
    """, unsafe_allow_html=True)

def get_growth_color_class(growth_rate: float) -> str:
    """ì„±ì¥ë¥ ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ë°˜í™˜"""
    if growth_rate > 5:
        return "growth-positive"
    elif growth_rate < -5:
        return "growth-negative"
    else:
        return "growth-neutral"

def format_growth_rate(rate: float) -> str:
    """ì„±ì¥ë¥ ì„ í¬ë§·íŒ…í•˜ì—¬ ë°˜í™˜"""
    if rate > 0:
        return f"+{rate:.2f}%"
    else:
        return f"{rate:.2f}%"

def create_growth_trend_chart(df: pd.DataFrame, title: str) -> go.Figure:
    """ì„±ì¥ë¥  íŠ¸ë Œë“œ ì°¨íŠ¸ ìƒì„±"""
    fig = go.Figure()
    
# í”Œë«í¼ë³„ ì°¨íŠ¸ ìƒì„± (ì„ì‹œ ë¹„í™œì„±í™”)    st.info("í”Œë«í¼ë³„ ì°¨íŠ¸ëŠ” ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.")
            y=platform_data['growth_rate'],
            mode='lines+markers',
            name=platform,
            line=dict(color=colors[i % len(colors)], width=2),
            marker=dict(size=6)
        ))
    
    fig.update_layout(
        title=title,
        xaxis_title="ë‚ ì§œ",
        yaxis_title="ì„±ì¥ë¥  (%)",
        height=400,
        template='plotly_white',
        hovermode='x unified',
        showlegend=True,
        legend=dict(
            orientation="h",
            yanchor="bottom",
            y=1.02,
            xanchor="right",
            x=1
        )
    )
    
    # 0% ê¸°ì¤€ì„  ì¶”ê°€
    fig.add_hline(y=0, line_dash="dash", line_color="gray", opacity=0.5)
    
    return fig

def create_platform_comparison_chart(metrics_summary: Dict) -> go.Figure:
    """í”Œë«í¼ë³„ ì„±ì¥ë¥  ë¹„êµ ì°¨íŠ¸ ìƒì„±"""
    platforms = list(metrics_summary.keys())
    growth_rates = [metrics_summary[p]['avg_growth_rate'] for p in platforms]
    
    # ì„±ì¥ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
    colors = ['#4CAF50' if rate > 5 else '#f44336' if rate < -5 else '#FF9800' 
              for rate in growth_rates]
    
    fig = go.Figure(data=[
        go.Bar(
            x=platforms,
            y=growth_rates,
            marker_color=colors,
            text=[f"{rate:.1f}%" for rate in growth_rates],
            textposition='auto',
        )
    ])
    
    fig.update_layout(
        title="í”Œë«í¼ë³„ í‰ê·  ì„±ì¥ë¥  ë¹„êµ",
        xaxis_title="í”Œë«í¼",
        yaxis_title="í‰ê·  ì„±ì¥ë¥  (%)",
        height=400,
        template='plotly_white'
    )
    
    return fig

def create_growth_heatmap(df: pd.DataFrame) -> go.Figure:
    """ì„±ì¥ë¥  íˆíŠ¸ë§µ ìƒì„±"""
    # í”¼ë²— í…Œì´ë¸” ìƒì„±
    pivot_df = df.pivot_table(
        index='platform',
        columns=df['date'].dt.strftime('%Y-%m'),
        values='growth_rate',
        aggfunc='mean'
    )
# íˆíŠ¸ë§µ ì°¨íŠ¸ (ì„ì‹œ ë¹„í™œì„±í™”)    st.info("íˆíŠ¸ë§µ ì°¨íŠ¸ëŠ” ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.")
        title="ì›”ë³„ í”Œë«í¼ ì„±ì¥ë¥  íˆíŠ¸ë§µ",
        xaxis_title="ì›”",
        yaxis_title="í”Œë«í¼",
        height=400,
        template='plotly_white'
    )
    
    return fig

# Main page content
st.title("ğŸ“ˆ ì„±ì¥ë¥  ë¶„ì„")
st.caption("K-Pop ì•„í‹°ìŠ¤íŠ¸ì˜ í”Œë«í¼ë³„ ì„±ì¥ë¥ ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤")# ë¶„ì„ ë‹¨ìœ„ ì„ íƒanalysis_unit = st.radio(    "ë¶„ì„ ë‹¨ìœ„ ì„ íƒ",    ["ê°œë³„ ì•„í‹°ìŠ¤íŠ¸", "ê·¸ë£¹ ë‹¨ìœ„"],    horizontal=True)# ì„ì‹œë¡œ ëª¨ë“  ë¶„ì„ì„ ì•„í‹°ìŠ¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬artists = get_all_artists_with_details()if artists:    artist_options = {f"{artist["artist_name"]} ({artist["group_name"] or "ì†”ë¡œ"})" : artist["artist_id"]                      for artist in artists}    selected_artist_label = st.selectbox(        "ë¶„ì„í•  ëŒ€ìƒ ì„ íƒ",        options=list(artist_options.keys()),        index=0    )    selected_artist_id = artist_options[selected_artist_label]else:    st.error("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")    st.stop()# í”Œë«í¼ ì„ íƒplatform_options = ["YouTube", "Instagram", "TikTok", "Twitter", "Spotify"]selected_platforms = st.multiselect(    "ë¶„ì„í•  í”Œë«í¼",    platform_options,    default=platform_options[:3])# Main content areaif not selected_platforms:
# ë¶„ì„ ì„¤ì •st.info("ë¶„ì„ ê¸°ëŠ¥ì„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...")# ì„ì‹œ í”Œë ˆì´ìŠ¤í™€ë”st.warning("ì„±ì¥ë¥  ë¶„ì„ ê¸°ëŠ¥ì€ í˜„ì¬ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.")selected_platforms = ["YouTube", "Instagram", "TikTok"]if not selected_platforms:
# ìƒë‹¨ ë©”íŠ¸ë¦­ ì¹´ë“œë“¤
col1, col2, col3, col4 = st.columns(4)

with col1:
    overall_avg_growth = df['growth_rate'].mean()
    st.markdown(f"""
    <div class="metric-card">
        <h4>ğŸ“Š ì „ì²´ í‰ê·  ì„±ì¥ë¥ </h4>
# ë¶„ì„ ê²°ê³¼ í‘œì‹œcol1, col2, col3, col4 = st.columns(4)# ì„ì‹œ ìƒ˜í”Œ ë°ì´í„°ë¡œ ëŒ€ì²´sample_growth_rate = 15.2with col1:    st.metric(        label="ì „ì²´ í‰ê·  ì„±ì¥ë¥ ",        value=f"+{sample_growth_rate:.1f}%",        delta="ì „ë…„ ë™ê¸° ëŒ€ë¹„"    )
    <div class="metric-card">
        <h4>ğŸ“… ë¶„ì„ ê¸°ê°„</h4>
        <h3>{total_days}ì¼</h3>
        <p>{start_date.strftime('%Y.%m.%d')} ~ {end_date.strftime('%Y.%m.%d')}</p>
    </div>
    """, unsafe_allow_html=True)

with col4:
    data_quality = df['confidence'].mean()
    st.markdown(f"""
    <div class="metric-card">
        <h4>ğŸ¯ ë°ì´í„° ì‹ ë¢°ë„</h4>
        <h3>{data_quality:.1%}</h3>
        <p>í†µê³„ì  ì‹ ë¢°ìˆ˜ì¤€</p>
    </div>
    """, unsafe_allow_html=True)

st.markdown("---")

# ì°¨íŠ¸ ì„¹ì…˜
col_left, col_right = st.columns([2, 1])

# ë°ì´í„° í’ˆì§ˆ ë©”íŠ¸ë¦­ (ì„ì‹œ ìƒ˜í”Œ ë°ì´í„°)    sample_quality = 85.5        with col2:        st.metric(            label="ë°ì´í„° í’ˆì§ˆ",            value=f"{sample_quality:.1f}%",            delta="ì‹ ë¢°ë„ ì§€ìˆ˜"        )
        recent_growth = df[df['date'] >= (end_date - timedelta(days=7))]['growth_rate'].mean()
        previous_growth = df[df['date'] < (end_date - timedelta(days=7))]['growth_rate'].mean()
        trend_change = recent_growth - previous_growth
        
        if abs(trend_change) > 1:
            trend_text = "ê¸‰ìƒìŠ¹" if trend_change > 0 else "ê¸‰í•˜ë½"
            trend_icon = "ğŸš€" if trend_change > 0 else "ğŸ“‰"
        else:
            trend_text = "ì•ˆì •"
            trend_icon = "ğŸ“Š"
        
        st.markdown(f"""
        <div class="insight-card">
            <h4>{trend_icon} ìµœê·¼ íŠ¸ë Œë“œ ë¶„ì„</h4>
            <p>ìµœê·¼ 7ì¼ í‰ê·  ì„±ì¥ë¥ : <strong>{format_growth_rate(recent_growth)}</strong></p>
            <p>ì´ì „ ê¸°ê°„ ëŒ€ë¹„: <strong>{trend_text}</strong> ({format_growth_rate(trend_change)}p)</p>
        </div>
        """, unsafe_allow_html=True)
    
    with tab2:
        comparison_chart = create_platform_comparison_chart(metrics_summary)
        st.plotly_chart(comparison_chart, use_container_width=True)
        
        # í”Œë«í¼ë³„ ì¸ì‚¬ì´íŠ¸
# ì„±ì¥ë¥  ë³€í™” ë©”íŠ¸ë¦­ (ì„ì‹œ ìƒ˜í”Œ ë°ì´í„°)    sample_recent_growth = 18.2    sample_previous_growth = 15.7    growth_change = sample_recent_growth - sample_previous_growth        with col3:        st.metric(            label="ì„±ì¥ë¥  ë³€í™”",            value=f"+{growth_change:.1f}%",            delta="ì§€ë‚œì£¼ ëŒ€ë¹„"        )
        if len(df) > 30:  # ì¶©ë¶„í•œ ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ íˆíŠ¸ë§µ í‘œì‹œ
            heatmap_chart = create_growth_heatmap(df)
            st.plotly_chart(heatmap_chart, use_container_width=True)
        else:
            st.info("íˆíŠ¸ë§µ í‘œì‹œë¥¼ ìœ„í•´ì„œëŠ” ë” ë§ì€ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
    
    st.markdown('</div>', unsafe_allow_html=True)

with col_right:
    # ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” - ì¶”ê°€ ì •ë³´ ë° ì¸ì‚¬ì´íŠ¸
    st.markdown("### ğŸ” ìƒì„¸ ë¶„ì„")
    
    # ì„±ì¥ë¥  ë¶„í¬
    st.markdown("#### ğŸ“Š ì„±ì¥ë¥  ë¶„í¬")
    fig_hist = px.histogram(
        df, x='growth_rate', 
        title="ì„±ì¥ë¥  ë¶„í¬",
        nbins=20,
        color_discrete_sequence=['#667eea']
    )
    fig_hist.update_layout(height=250, showlegend=False)
    st.plotly_chart(fig_hist, use_container_width=True)
    
    # í†µê³„ ìš”ì•½
    st.markdown("#### ğŸ“ˆ í†µê³„ ìš”ì•½")
    growth_stats = df['growth_rate'].describe()
    st.dataframe({
        "í†µê³„": ["í‰ê· ", "í‘œì¤€í¸ì°¨", "ìµœì†Œê°’", "25%", "50%", "75%", "ìµœëŒ€ê°’"],
        "ê°’": [
            f"{growth_stats['mean']:.2f}%",
            f"{growth_stats['std']:.2f}%",
            f"{growth_stats['min']:.2f}%",
            f"{growth_stats['25%']:.2f}%",
            f"{growth_stats['50%']:.2f}%",
            f"{growth_stats['75%']:.2f}%",
            f"{growth_stats['max']:.2f}%"
        ]
    }, use_container_width=True)
    
    # ì‹¤ì‹œê°„ ì•Œë¦¼ ì„¹ì…˜
    st.markdown("#### ğŸš¨ ì„±ì¥ë¥  ì•Œë¦¼")
    
    # ì„ê³„ê°’ ì„¤ì •
    high_growth_threshold = st.slider("ë†’ì€ ì„±ì¥ë¥  ì„ê³„ê°’ (%)", 1.0, 10.0, 5.0)
    low_growth_threshold = st.slider("ë‚®ì€ ì„±ì¥ë¥  ì„ê³„ê°’ (%)", -10.0, -1.0, -3.0)
    
    # ì•Œë¦¼ ì¡°ê±´ í™•ì¸
    high_growth_days = df[df['growth_rate'] >= high_growth_threshold]
    low_growth_days = df[df['growth_rate'] <= low_growth_threshold]
    
    if not high_growth_days.empty:
        st.success(f"ğŸš€ ë†’ì€ ì„±ì¥ë¥  ë‹¬ì„±: {len(high_growth_days)}ì¼")
        
    if not low_growth_days.empty:
        st.warning(f"ğŸ“‰ ë‚®ì€ ì„±ì¥ë¥  ë°œìƒ: {len(low_growth_days)}ì¼")
    
    if high_growth_days.empty and low_growth_days.empty:
        st.info("ğŸ“Š ì•ˆì •ì ì¸ ì„±ì¥ íŒ¨í„´ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤")

# í†µê³„ ìš”ì•½ (ì„ì‹œ ìƒ˜í”Œ ë°ì´í„°)    st.subheader("ğŸ“Š í†µê³„ ìš”ì•½")    st.info("í†µê³„ ë¶„ì„ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.")

# ë°ì´í„° í…Œì´ë¸”
display_df_formatted = display_df.copy()
display_df_formatted['date'] = display_df_formatted['date'].dt.strftime('%Y-%m-%d')
display_df_formatted['growth_rate'] = display_df_formatted['growth_rate'].apply(lambda x: f"{x:.2f}%")
display_df_formatted['followers'] = display_df_formatted['followers'].apply(lambda x: f"{x:,}")
display_df_formatted['confidence'] = display_df_formatted['confidence'].apply(lambda x: f"{x:.1%}")

st.dataframe(
    display_df_formatted,
    column_config={
        "date": "ë‚ ì§œ",
        "platform": "í”Œë«í¼",
        "growth_rate": "ì„±ì¥ë¥ ",
        "followers": "íŒ”ë¡œì›Œ ìˆ˜",
        "confidence": "ì‹ ë¢°ë„"
    },
    hide_index=True,
    use_container_width=True
# ì„±ì¥ë¥  ë¶„ì„ (ì„ì‹œ ë¹„í™œì„±í™”)    st.subheader("ğŸ“ˆ ì„±ì¥ë¥  ë¶„ì„")    st.info("ìƒì„¸ ì„±ì¥ë¥  ë¶„ì„ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.")
    <p>ğŸ’¡ ë” ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ì„œëŠ” ë” ë§ì€ ë°ì´í„° í¬ì¸íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
    <p>ğŸ”„ ë°ì´í„°ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ë©° 5ë¶„ê°„ ìºì‹±ë©ë‹ˆë‹¤</p>
</div>
""".format(selected_method_label=selected_method_label), unsafe_allow_html=True)
"""
ê²½ì˜ì§„ KPI ëŒ€ì‹œë³´ë“œ
=================

K-Pop ì—”í„°í…Œì¸ë¨¼íŠ¸ íšŒì‚¬ ê²½ì˜ì§„ì„ ìœ„í•œ ì‹¤ì‹œê°„ KPI ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤.
- ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™
- í•µì‹¬ ì„±ê³¼ ì§€í‘œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
- Top ì„±ì¥ ê·¸ë£¹ ìë™ ì‹ë³„
- í”Œë«í¼ë³„ ì„±ê³¼ ìš”ì•½

Author: Backend Development Team
Date: 2025-09-11
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import numpy as np
from datetime import datetime, timedelta
import warnings
warnings.filterwarnings('ignore')

# Import internal modules
try:
    from database_postgresql import (
        get_executive_kpi_summary, get_top_growing_groups, 
        get_platform_summary_stats, format_number, calculate_growth_percentage
    )
except ImportError as e:
    st.error(f"ëª¨ë“ˆ import ì˜¤ë¥˜: {e}")
    st.stop()

# Page configuration
st.set_page_config(
    page_title="ê²½ì˜ì§„ KPI",
    page_icon="ğŸ“Š",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS for executive dashboard
st.markdown("""
<style>
    .executive-header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        padding: 2rem;
        border-radius: 15px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .kpi-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
        border-left: 5px solid #2a5298;
        transition: transform 0.2s ease;
    }
    
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    
    .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0.5rem 0;
    }
    
    .kpi-positive { color: #28a745; }
    .kpi-negative { color: #dc3545; }
    .kpi-warning { color: #ffc107; }
    .kpi-neutral { color: #6c757d; }
    
    .top-performer-card {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        margin: 0.5rem 0;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .platform-summary {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin: 0.5rem 0;
        border-left: 4px solid #17a2b8;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    
    .status-green { background-color: #28a745; }
    .status-yellow { background-color: #ffc107; }
    .status-red { background-color: #dc3545; }
    
    .dashboard-section {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    
    @media (max-width: 768px) {
        .executive-header { padding: 1rem; }
        .kpi-card { padding: 1rem; }
        .kpi-value { font-size: 2rem; }
    }
</style>
""", unsafe_allow_html=True)

# Main header
st.markdown("""
<div class="executive-header">
    <h1>ğŸ“Š ê²½ì˜ì§„ KPI ëŒ€ì‹œë³´ë“œ</h1>
    <p>K-Pop ì—”í„°í…Œì¸ë¨¼íŠ¸ ì¢…í•© ì„±ê³¼ ëª¨ë‹ˆí„°ë§</p>
</div>
""", unsafe_allow_html=True)

# Load data
@st.cache_data(ttl=300)  # 5ë¶„ ìºì‹±
def load_kpi_data():
    """KPI ë°ì´í„° ë¡œë“œ"""
    summary = get_executive_kpi_summary()
    top_groups = get_top_growing_groups(limit=5)
    platform_stats = get_platform_summary_stats()
    return summary, top_groups, platform_stats

try:
    with st.spinner("ğŸ“Š ì‹¤ì‹œê°„ KPI ë°ì´í„°ë¥¼ ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
        summary_data, top_growing_groups, platform_summary = load_kpi_data()
        
    if not summary_data or not summary_data.get('counts'):
        st.error("âš ï¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
        st.stop()
        
    # í•µì‹¬ ì§€í‘œ ì¹´ë“œ
    st.markdown("### ğŸ“ˆ í•µì‹¬ ì„±ê³¼ ì§€í‘œ")
    col1, col2, col3, col4 = st.columns(4)
    
    counts = summary_data['counts']
    
    with col1:
        total_artists = counts.get('total_artists', 0)
        st.metric(
            label="ì´ ì•„í‹°ìŠ¤íŠ¸ ìˆ˜", 
            value=f"{total_artists:,}",
            delta="í™œì„± ê´€ë¦¬ ì¤‘"
        )
    
    with col2:
        total_groups = counts.get('total_groups', 0)  
        st.metric(
            label="í™œì„± ê·¸ë£¹ ìˆ˜", 
            value=f"{total_groups:,}",
            delta="í¬íŠ¸í´ë¦¬ì˜¤"
        )
        
    with col3:
        total_accounts = counts.get('total_accounts', 0)
        st.metric(
            label="ì—°ë™ ê³„ì • ìˆ˜", 
            value=f"{total_accounts:,}",
            delta="ë°ì´í„° ìˆ˜ì§‘ ì¤‘"
        )
        
    with col4:
        total_companies = counts.get('total_companies', 0)
        st.metric(
            label="ê´€ë¦¬ íšŒì‚¬ ìˆ˜", 
            value=f"{total_companies:,}",
            delta="ì „ì²´ ë„¤íŠ¸ì›Œí¬"
        )
    
    st.markdown("---")
    
    # í”Œë«í¼ë³„ ì„±ê³¼ ë° Top ê·¸ë£¹ ì„¹ì…˜
    col_left, col_right = st.columns([2, 1])
    
    with col_left:
        st.markdown("### ğŸ“± í”Œë«í¼ë³„ ì„±ê³¼ í˜„í™©")
        
        if platform_summary:
            # í”Œë«í¼ ì„±ê³¼ ì°¨íŠ¸
            df_platform = pd.DataFrame(platform_summary)
            
            fig = go.Figure()
            
            # í˜„ì¬ ì´í•© ë§‰ëŒ€ ì°¨íŠ¸
            fig.add_trace(go.Bar(
                name='í˜„ì¬ íŒ”ë¡œì›Œ/êµ¬ë…ì',
                x=df_platform['platform'],
                y=df_platform['current_total'],
                text=[format_number(x) for x in df_platform['current_total']],
                textposition='auto',
                marker_color='#2a5298'
            ))
            
            fig.update_layout(
                title="í”Œë«í¼ë³„ ì´ íŒ”ë¡œì›Œ/êµ¬ë…ì ìˆ˜",
                xaxis_title="í”Œë«í¼",
                yaxis_title="íŒ”ë¡œì›Œ/êµ¬ë…ì ìˆ˜",
                height=400,
                template='plotly_white'
            )
            
            st.plotly_chart(fig, use_container_width=True)
            
            # í”Œë«í¼ë³„ ìƒì„¸ ì •ë³´
            for platform_data in platform_summary:
                growth_rate = platform_data['growth_rate']
                growth_class = "kpi-positive" if growth_rate > 0 else "kpi-negative" if growth_rate < -5 else "kpi-neutral"
                
                st.markdown(f"""
                <div class="platform-summary">
                    <h4>{platform_data['platform'].title()}</h4>
                    <p><strong>ì´ {format_number(platform_data['current_total'])}</strong> íŒ”ë¡œì›Œ/êµ¬ë…ì</p>
                    <p><strong>{platform_data['active_accounts']}ê°œ</strong> í™œì„± ê³„ì •</p>
                    <p>ì§€ë‚œì£¼ ëŒ€ë¹„: <span class="{growth_class}"><strong>{growth_rate:+.1f}%</strong></span></p>
                </div>
                """, unsafe_allow_html=True)
        else:
            st.info("ğŸ“Š í”Œë«í¼ ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤...")
    
    with col_right:
        st.markdown("### ğŸ† Top 5 ì„±ì¥ ê·¸ë£¹")
        
        if top_growing_groups:
            for i, group in enumerate(top_growing_groups, 1):
                growth_rate = group['growth_rate']
                status_class = "status-green" if growth_rate > 10 else "status-yellow" if growth_rate > 0 else "status-red"
                
                st.markdown(f"""
                <div class="top-performer-card">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div class="status-indicator {status_class}"></div>
                            <strong>#{i} {group['group_name']}</strong>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold;">{growth_rate:+.1f}%</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">{group['company_name']}</div>
                        </div>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.9;">
                        ì´ {format_number(group['total_followers'])} íŒ”ë¡œì›Œ Â· {group['platform_count']}ê°œ í”Œë«í¼
                    </div>
                </div>
                """, unsafe_allow_html=True)
        else:
            st.info("ğŸ” ì„±ì¥ë¥  ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...")
            
    st.markdown("---")
    
    # ì¶”ê°€ ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜
    col_insight1, col_insight2 = st.columns(2)
    
    with col_insight1:
        st.markdown("""
        <div class="dashboard-section">
            <h4>ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h4>
            <ul>
                <li><strong>í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©:</strong> {total_groups}ê°œ ê·¸ë£¹, {total_artists}ëª… ì•„í‹°ìŠ¤íŠ¸ ê´€ë¦¬</li>
                <li><strong>ë°ì´í„° ì»¤ë²„ë¦¬ì§€:</strong> {total_accounts}ê°œ ì†Œì…œë¯¸ë””ì–´ ê³„ì • ì—°ë™</li>
                <li><strong>ì„±ì¥ë¥  ë¶„ì„:</strong> ìƒìœ„ ê·¸ë£¹ë“¤ì´ ì•ˆì •ì ì¸ ì„±ì¥ì„¸ ìœ ì§€</li>
                <li><strong>í”Œë«í¼ ë‹¤ì–‘í™”:</strong> ë‹¤ì¤‘ í”Œë«í¼ ì „ëµìœ¼ë¡œ ë¦¬ìŠ¤í¬ ë¶„ì‚°</li>
            </ul>
        </div>
        """.format(
            total_groups=total_groups,
            total_artists=total_artists, 
            total_accounts=total_accounts
        ), unsafe_allow_html=True)
        
    with col_insight2:
        st.markdown("""
        <div class="dashboard-section">
            <h4>âš ï¸ ì£¼ì˜ì‚¬í•­ ë° ê¶Œê³ </h4>
            <ul>
                <li><strong>ë°ì´í„° ìˆ˜ì§‘:</strong> ëª¨ë“  ê³„ì •ì˜ ìµœì‹  ë°ì´í„° í™•ë³´ í•„ìš”</li>
                <li><strong>ì„±ì¥ë¥  ëª¨ë‹ˆí„°ë§:</strong> ì£¼ê°„ ë‹¨ìœ„ ì„±ì¥ë¥  ì¶”ì  ê°•í™”</li>
                <li><strong>í”Œë«í¼ í™•ì¥:</strong> TikTok ë“± ì‹ ê·œ í”Œë«í¼ ì—°ë™ ê²€í† </li>
                <li><strong>ëª©í‘œ ì„¤ì •:</strong> ê·¸ë£¹ë³„ ì„±ê³¼ ëª©í‘œ ë° KPI ì„¤ì •</li>
            </ul>
        </div>
        """, unsafe_allow_html=True)
    
    # í˜ì´ì§€ í•˜ë‹¨ ì •ë³´
    st.markdown("""
    <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
        <p style="margin: 0; color: #6c757d;">
            ğŸ“Š <strong>ì‹¤ì‹œê°„ ë°ì´í„°</strong> Â· 
            ğŸ”„ <strong>5ë¶„ë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸</strong> Â· 
            ğŸ¯ <strong>{update_time} ê¸°ì¤€</strong>
        </p>
    </div>
    """.format(update_time=datetime.now().strftime("%Y-%m-%d %H:%M")), unsafe_allow_html=True)
    
except Exception as e:
    st.error(f"âš ï¸ KPI ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
    st.info("ğŸ”§ ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")

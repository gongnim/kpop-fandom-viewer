"""
K-Pop ì´ë²¤íŠ¸ ê´€ë¦¬ í˜ì´ì§€
ì´ë²¤íŠ¸ ë‹¬ë ¥, ì‹œìƒì‹, ì»´ë°± ë¶„ì„, ì˜í–¥ë„ ì¸¡ì • ê¸°ëŠ¥ ì œê³µ
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from datetime import date, datetime, timedelta
from typing import Dict, List, Any, Optional
import logging

# ìƒìœ„ ë””ë ‰í† ë¦¬ì—ì„œ ëª¨ë“ˆ import
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from database_postgresql import DatabaseManager, get_companies, get_groups, get_artists
from analytics.kpop_event_calendar import KPopEventCalendar, EventCategory, EventImportance
from analytics.award_shows_data import AwardShowDataManager
from analytics.comeback_season_analyzer import ComebackSeasonAnalyzer, ComebackSeason
from analytics.event_impact_analyzer import EventImpactAnalyzer, ImpactType, ImpactDirection

logger = logging.getLogger(__name__)

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="K-Pop ì´ë²¤íŠ¸ ê´€ë¦¬",
    page_icon="ğŸ“…",
    layout="wide"
)

st.title("ğŸ“… K-Pop ì´ë²¤íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ")
st.markdown("---")

# ë°ì´í„°ë² ì´ìŠ¤ ë§¤ë‹ˆì € ì´ˆê¸°í™”
@st.cache_resource
def init_database():
    """ë°ì´í„°ë² ì´ìŠ¤ ë§¤ë‹ˆì € ì´ˆê¸°í™”"""
    return DatabaseManager()

@st.cache_resource
def init_event_systems():
    """ì´ë²¤íŠ¸ ë¶„ì„ ì‹œìŠ¤í…œ ì´ˆê¸°í™”"""
    calendar = KPopEventCalendar()
    award_manager = AwardShowDataManager()
    comeback_analyzer = ComebackSeasonAnalyzer()
    impact_analyzer = EventImpactAnalyzer()
    
    return calendar, award_manager, comeback_analyzer, impact_analyzer

# ì‹œìŠ¤í…œ ì´ˆê¸°í™”
db_manager = init_database()
event_calendar, award_manager, comeback_analyzer, impact_analyzer = init_event_systems()

# ì‚¬ì´ë“œë°” ë©”ë‰´
with st.sidebar:
    st.header("ğŸ“‹ ë©”ë‰´")
    menu_option = st.selectbox(
        "ê¸°ëŠ¥ ì„ íƒ",
        ["ğŸ“… ì´ë²¤íŠ¸ ë‹¬ë ¥", "ğŸ† ì‹œìƒì‹ ê´€ë¦¬", "ğŸµ ì»´ë°± ë¶„ì„", "ğŸ“Š ì˜í–¥ë„ ë¶„ì„", "ğŸ“ˆ íŒ¨í„´ ë¶„ì„"]
    )
    
    st.markdown("---")
    
    # í•„í„° ì˜µì…˜
    st.subheader("ğŸ” í•„í„°")
    
    # ë‚ ì§œ ë²”ìœ„ ì„ íƒ
    date_range = st.date_input(
        "ë‚ ì§œ ë²”ìœ„",
        value=[date.today() - timedelta(days=30), date.today() + timedelta(days=90)],
        key="date_range_filter"
    )
    
    # ì´ë²¤íŠ¸ ì¹´í…Œê³ ë¦¬ ì„ íƒ
    selected_categories = st.multiselect(
        "ì´ë²¤íŠ¸ ì¹´í…Œê³ ë¦¬",
        options=[cat.value for cat in EventCategory],
        default=[EventCategory.AWARD_SHOW.value, EventCategory.COMEBACK.value, EventCategory.CONCERT.value],
        key="category_filter"
    )

# ==================== ì´ë²¤íŠ¸ ë‹¬ë ¥ ====================
if menu_option == "ğŸ“… ì´ë²¤íŠ¸ ë‹¬ë ¥":
    st.header("ğŸ“… K-Pop ì´ë²¤íŠ¸ ë‹¬ë ¥")
    
    # íƒ­ìœ¼ë¡œ êµ¬ë¶„
    tab1, tab2, tab3 = st.tabs(["ğŸ“‹ ì´ë²¤íŠ¸ ëª©ë¡", "â• ì´ë²¤íŠ¸ ì¶”ê°€", "ğŸ“Š ì›”ë³„ í†µê³„"])
    
    with tab1:
        st.subheader("ì´ë²¤íŠ¸ ëª©ë¡")
        
        # ì´ë²¤íŠ¸ ë°ì´í„° ì¡°íšŒ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒ)
# ì„ì‹œë¡œ ìƒ˜í”Œ ë°ì´í„° í‘œì‹œ        st.info("ì´ë²¤íŠ¸ ë°ì´í„° ë¡œë”© ì¤‘...")                # TODO: ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ êµ¬í˜„ í•„ìš”        st.warning("í˜„ì¬ ê°œë°œ ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤.")                # ì›”ë³„ í†µê³„ëŠ” í•˜ë“œì½”ë”©ëœ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©        sample_monthly_stats = {            "1ì›”": 5, "2ì›”": 3, "3ì›”": 8, "4ì›”": 6, "5ì›”": 4, "6ì›”": 7,            "7ì›”": 9, "8ì›”": 5, "9ì›”": 6, "10ì›”": 8, "11ì›”": 12, "12ì›”": 10        }
    
    with tab3:
        st.subheader("ì›”ë³„ ì´ë²¤íŠ¸ í†µê³„")
        
        # ì›”ë³„ ì´ë²¤íŠ¸ ìˆ˜ ì°¨íŠ¸
        monthly_data = {
            "month": ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"],
            "events": [5, 3, 8, 12, 15, 10, 7, 9, 11, 18, 22, 14]
        }
        
        fig = px.bar(
            x=monthly_data["month"],
            y=monthly_data["events"],
            title="ì›”ë³„ ì´ë²¤íŠ¸ ìˆ˜",
            labels={"x": "ì›”", "y": "ì´ë²¤íŠ¸ ìˆ˜"},
            color=monthly_data["events"],
            color_continuous_scale="viridis"
        )
        
        st.plotly_chart(fig, use_container_width=True)
        
        # ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬
        category_data = {
            "category": ["ì‹œìƒì‹", "ì»´ë°±", "ì½˜ì„œíŠ¸", "ì½œë¼ë³´", "ê¸°íƒ€"],
            "count": [25, 45, 30, 15, 20]
        }
        
        fig_pie = px.pie(
            values=category_data["count"],
            names=category_data["category"],
            title="ì¹´í…Œê³ ë¦¬ë³„ ì´ë²¤íŠ¸ ë¶„í¬"
        )
        
        st.plotly_chart(fig_pie, use_container_width=True)

# ==================== ì‹œìƒì‹ ê´€ë¦¬ ====================
elif menu_option == "ğŸ† ì‹œìƒì‹ ê´€ë¦¬":
    st.header("ğŸ† K-Pop ì‹œìƒì‹ ê´€ë¦¬")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ“‹ ì‹œìƒì‹ ì •ë³´", "ğŸ“Š ì—°ê°„ ë‹¬ë ¥", "ğŸ… ìˆ˜ìƒ ê¸°ë¡"])
    
    with tab1:
        st.subheader("ì£¼ìš” K-Pop ì‹œìƒì‹")
        
        # ì‹œìƒì‹ ë°ì´í„° ì¡°íšŒ
        try:
            award_shows = award_manager.get_all_award_shows()
            
            for show_name, show_info in award_shows.items():
                with st.expander(f"ğŸ† {show_name}", expanded=False):
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        st.write(f"**ì£¼ìµœ:** {show_info.organizer}")
                        st.write(f"**íšŒì¥ ê·œëª¨:** {show_info.venue_capacity:,}ëª…")
                        st.write(f"**ë°©ì†¡ì‚¬:** {', '.join(show_info.broadcast_channels)}")
                    
                    with col2:
                        if show_info.voting_start_date:
                            st.write(f"**íˆ¬í‘œ ì‹œì‘:** {show_info.voting_start_date}")
                        if show_info.voting_end_date:
                            st.write(f"**íˆ¬í‘œ ì¢…ë£Œ:** {show_info.voting_end_date}")
                        st.write(f"**ì˜í–¥ë„ ì ìˆ˜:** {show_info.impact_metrics.get('global_impact_score', 'N/A')}")
                    
                    # ìˆ˜ìƒ ë¶€ë¬¸ ì •ë³´
                    if show_info.award_categories:
                        st.write("**ì£¼ìš” ìˆ˜ìƒ ë¶€ë¬¸:**")
                        categories = list(show_info.award_categories.keys())[:5]  # ì²˜ìŒ 5ê°œë§Œ í‘œì‹œ
                        for category in categories:
                            st.write(f"â€¢ {category}")
        
        except Exception as e:
            st.error(f"ì‹œìƒì‹ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: {e}")
    
    with tab2:
        st.subheader("ì—°ê°„ ì‹œìƒì‹ ë‹¬ë ¥")
        
        try:
            # ì—°ê°„ ì‹œìƒì‹ ì¼ì • ìƒì„±
            current_year = datetime.now().year
            annual_calendar = award_manager.generate_annual_calendar(current_year)
            
            if annual_calendar:
                # ì›”ë³„ë¡œ ì •ë¦¬
                monthly_awards = {}
                for event in annual_calendar:
                    month = event['date'].month
                    if month not in monthly_awards:
                        monthly_awards[month] = []
                    monthly_awards[month].append(event)
                
                # ì›”ë³„ í‘œì‹œ
                for month in range(1, 13):
                    if month in monthly_awards:
                        st.write(f"### {month}ì›”")
                        for event in monthly_awards[month]:
                            st.write(f"â€¢ **{event['name']}** - {event['date'].strftime('%m/%d')}")
                        st.write("")
            else:
                st.info("ì‹œìƒì‹ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.")
        
        except Exception as e:
            st.error(f"ì—°ê°„ ë‹¬ë ¥ ìƒì„± ì‹¤íŒ¨: {e}")
    
    with tab3:
        st.subheader("ìˆ˜ìƒ ê¸°ë¡ ë¶„ì„")
        
        # ìƒ˜í”Œ ìˆ˜ìƒ ë°ì´í„°
        award_data = {
            "artist": ["BTS", "BLACKPINK", "NewJeans", "aespa", "SEVENTEEN"],
            "awards_count": [15, 12, 8, 10, 11],
            "major_awards": [8, 6, 4, 5, 7]
        }
        
        fig = go.Figure()
        fig.add_trace(go.Bar(
            name="ì´ ìˆ˜ìƒ ìˆ˜",
            x=award_data["artist"],
            y=award_data["awards_count"],
            marker_color="lightblue"
        ))
        fig.add_trace(go.Bar(
            name="ì£¼ìš” ìƒ ìˆ˜ìƒ ìˆ˜", 
            x=award_data["artist"],
            y=award_data["major_awards"],
            marker_color="darkblue"
        ))
        
        fig.update_layout(
            title="ì•„í‹°ìŠ¤íŠ¸ë³„ ìˆ˜ìƒ ê¸°ë¡",
            xaxis_title="ì•„í‹°ìŠ¤íŠ¸",
            yaxis_title="ìˆ˜ìƒ ìˆ˜",
            barmode="group"
        )
        
        st.plotly_chart(fig, use_container_width=True)

# ==================== ì»´ë°± ë¶„ì„ ====================
elif menu_option == "ğŸµ ì»´ë°± ë¶„ì„":
    st.header("ğŸµ ì»´ë°± ì‹œì¦Œ ë¶„ì„")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ“ˆ ì‹œì¦Œ íŒ¨í„´", "ğŸ” ê²½ìŸ ë¶„ì„", "ğŸ¯ ìµœì  íƒ€ì´ë°"])
    
    with tab1:
        st.subheader("ê³„ì ˆë³„ ì»´ë°± íŒ¨í„´")
        
        try:
            # ê³„ì ˆë³„ ì»´ë°± ë°ì´í„° ë¶„ì„
            seasonal_data = {
                "season": ["ë´„", "ì—¬ë¦„", "ê°€ì„", "ê²¨ìš¸"],
                "comeback_count": [45, 38, 52, 31],
                "avg_impact": [3.2, 2.8, 3.7, 2.9]
            }
            
            fig = make_subplots(
                rows=1, cols=2,
                subplot_titles=("ê³„ì ˆë³„ ì»´ë°± ìˆ˜", "ê³„ì ˆë³„ í‰ê·  ì˜í–¥ë„"),
                specs=[[{"secondary_y": False}, {"secondary_y": False}]]
            )
            
            # ì»´ë°± ìˆ˜ ì°¨íŠ¸
            fig.add_trace(
                go.Bar(x=seasonal_data["season"], y=seasonal_data["comeback_count"], 
                       name="ì»´ë°± ìˆ˜", marker_color="skyblue"),
                row=1, col=1
            )
            
            # í‰ê·  ì˜í–¥ë„ ì°¨íŠ¸
            fig.add_trace(
                go.Bar(x=seasonal_data["season"], y=seasonal_data["avg_impact"],
                       name="í‰ê·  ì˜í–¥ë„", marker_color="lightcoral"),
                row=1, col=2
            )
            
            fig.update_layout(
                title_text="ê³„ì ˆë³„ ì»´ë°± ë¶„ì„",
                showlegend=False
            )
            
            st.plotly_chart(fig, use_container_width=True)
            
            # ì¸ì‚¬ì´íŠ¸ ì œê³µ
            st.markdown("### ğŸ“Š ë¶„ì„ ì¸ì‚¬ì´íŠ¸")
            st.info("ğŸ‚ **ê°€ì„ì´ ê°€ì¥ í™œë°œí•œ ì»´ë°± ì‹œì¦Œ**ì…ë‹ˆë‹¤. 52ê±´ì˜ ì»´ë°±ìœ¼ë¡œ ìµœë‹¤ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.")
            st.info("â„ï¸ **ê²¨ìš¸ì€ ìƒëŒ€ì ìœ¼ë¡œ ì¡°ìš©í•œ ì‹œì¦Œ**ì…ë‹ˆë‹¤. ì—°ë§ì—°ì‹œ íœ´ê°€ì² ì˜ ì˜í–¥ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.")
            st.info("ğŸŒ¸ **ë´„ê³¼ ê°€ì„ì´ ë†’ì€ ì˜í–¥ë„**ë¥¼ ë³´ì—¬, ì „ëµì ìœ¼ë¡œ ì¤‘ìš”í•œ ì‹œì¦Œìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤.")
        
        except Exception as e:
            st.error(f"ê³„ì ˆë³„ íŒ¨í„´ ë¶„ì„ ì‹¤íŒ¨: {e}")
    
    with tab2:
        st.subheader("ì»´ë°± ê²½ìŸ ë¶„ì„")
        
        # ì›”ë³„ ê²½ìŸ ìˆ˜ì¤€ ë°ì´í„°
        competition_data = {
            "month": list(range(1, 13)),
            "competition_level": [3, 2, 4, 3, 5, 4, 3, 4, 5, 4, 5, 2],
            "comeback_density": [12, 8, 18, 15, 25, 20, 16, 19, 28, 22, 30, 10]
        }
        
        fig = go.Figure()
        
        # ê²½ìŸ ìˆ˜ì¤€
        fig.add_trace(go.Scatter(
            x=competition_data["month"],
            y=competition_data["competition_level"],
            mode="lines+markers",
            name="ê²½ìŸ ìˆ˜ì¤€",
            line=dict(color="red", width=3),
            yaxis="y"
        ))
        
        # ì»´ë°± ë°€ë„
        fig.add_trace(go.Bar(
            x=competition_data["month"],
            y=competition_data["comeback_density"],
            name="ì»´ë°± ìˆ˜",
            marker_color="lightblue",
            opacity=0.7,
            yaxis="y2"
        ))
        
        fig.update_layout(
            title="ì›”ë³„ ì»´ë°± ê²½ìŸ ìˆ˜ì¤€",
            xaxis_title="ì›”",
            yaxis=dict(title="ê²½ìŸ ìˆ˜ì¤€", side="left"),
            yaxis2=dict(title="ì»´ë°± ìˆ˜", side="right", overlaying="y"),
            legend=dict(x=0.02, y=0.98)
        )
        
        st.plotly_chart(fig, use_container_width=True)
        
        # ê²½ìŸ ë¶„ì„ ê²°ê³¼
        st.markdown("### ğŸ”¥ ê²½ìŸ ë¶„ì„ ê²°ê³¼")
        
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("ìµœê³  ê²½ìŸ ì›”", "5ì›”, 9ì›”, 11ì›”", "ê²½ìŸ ìˆ˜ì¤€ 5")
        with col2:
            st.metric("ìµœì € ê²½ìŸ ì›”", "2ì›”, 12ì›”", "ê²½ìŸ ìˆ˜ì¤€ 2")
        with col3:
            st.metric("í‰ê·  ê²½ìŸ ìˆ˜ì¤€", "3.7", "0.3â†‘")
    
    with tab3:
        st.subheader("ìµœì  ì»´ë°± íƒ€ì´ë° ì¶”ì²œ")
        
        # ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ
        artist_options = ["BTS", "BLACKPINK", "NewJeans", "aespa", "SEVENTEEN", "ê¸°íƒ€"]
        selected_artist = st.selectbox("ì•„í‹°ìŠ¤íŠ¸ ì„ íƒ", artist_options)
        
        # ì»´ë°± íƒ€ì… ì„ íƒ
        comeback_type = st.selectbox("ì»´ë°± íƒ€ì…", ["ì •ê·œì•¨ë²”", "ë¯¸ë‹ˆì•¨ë²”", "ì‹±ê¸€", "ë¦¬íŒ¨í‚¤ì§€"])
        
        # ë¶„ì„ ë²„íŠ¼
        if st.button("ìµœì  íƒ€ì´ë° ë¶„ì„", type="primary"):
            with st.spinner("ìµœì  íƒ€ì´ë°ì„ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤..."):
                try:
                    # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ComebackSeasonAnalyzer ì‚¬ìš©
                    # ì—¬ê¸°ì„œëŠ” ìƒ˜í”Œ ê²°ê³¼ í‘œì‹œ
                    
                    st.markdown("### ğŸ¯ ì¶”ì²œ ê²°ê³¼")
                    
                    # ì¶”ì²œ ì‹œê¸°
                    recommended_periods = [
                        {"period": "2024ë…„ 4ì›”", "score": 8.5, "reason": "ì¤‘ê°„ ìˆ˜ì¤€ì˜ ê²½ìŸ, ë´„ ì‹œì¦Œ í˜¸ì¡°"},
                        {"period": "2024ë…„ 7ì›”", "score": 7.2, "reason": "ì—¬ë¦„ ì‹œì¦Œ, ìƒëŒ€ì ìœ¼ë¡œ ë‚®ì€ ê²½ìŸ"},
                        {"period": "2024ë…„ 10ì›”", "score": 9.1, "reason": "ê°€ì„ ì‹œì¦Œ í”„ë¦¬ë¯¸ì—„, ë†’ì€ ê´€ì‹¬ë„"}
                    ]
                    
                    for i, period in enumerate(recommended_periods, 1):
                        with st.container():
                            st.markdown(f"**{i}ìˆœìœ„: {period['period']}**")
                            
                            # ì ìˆ˜ í‘œì‹œ
                            progress_value = period['score'] / 10
                            st.progress(progress_value)
                            st.caption(f"ì¶”ì²œ ì ìˆ˜: {period['score']}/10 - {period['reason']}")
                            
                            if i < len(recommended_periods):
                                st.markdown("---")
                    
                    # ìƒì„¸ ë¶„ì„
                    st.markdown("### ğŸ“Š ìƒì„¸ ë¶„ì„")
                    
                    analysis_data = {
                        "factor": ["ê²½ìŸ ìˆ˜ì¤€", "ì‹œì¦Œ íš¨ê³¼", "ê³¼ê±° ì„±ê³¼", "ì „ì²´ íŠ¸ë Œë“œ"],
                        "weight": [0.3, 0.25, 0.25, 0.2],
                        "april_score": [7.5, 8.0, 8.5, 9.0],
                        "july_score": [8.5, 6.0, 7.0, 7.5],
                        "october_score": [6.0, 9.5, 9.5, 9.0]
                    }
                    
                    analysis_df = pd.DataFrame(analysis_data)
                    st.dataframe(analysis_df, use_container_width=True)
                    
                except Exception as e:
                    st.error(f"íƒ€ì´ë° ë¶„ì„ ì‹¤íŒ¨: {e}")

# ==================== ì˜í–¥ë„ ë¶„ì„ ====================
elif menu_option == "ğŸ“Š ì˜í–¥ë„ ë¶„ì„":
    st.header("ğŸ“Š ì´ë²¤íŠ¸ ì˜í–¥ë„ ë¶„ì„")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ“ˆ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§", "ğŸ” ìƒì„¸ ë¶„ì„", "ğŸ“‹ ì˜í–¥ë„ ê¸°ë¡"])
    
    with tab1:
        st.subheader("ì‹¤ì‹œê°„ ì˜í–¥ë„ ëª¨ë‹ˆí„°ë§")
        
        # ìµœê·¼ ì´ë²¤íŠ¸ ì˜í–¥ë„
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("í‰ê·  ì˜í–¥ë„", "15.3%", "2.1%â†‘")
        with col2:
            st.metric("ìµœê³  ì˜í–¥ë„", "45.2%", "5.3%â†‘")
        with col3:
            st.metric("ë¶„ì„ ì´ë²¤íŠ¸ ìˆ˜", "156", "12â†‘")
        with col4:
            st.metric("í†µê³„ì  ìœ ì˜ì„±", "87%", "3%â†‘")
        
        # ìµœê·¼ ì´ë²¤íŠ¸ ì˜í–¥ë„ íŠ¸ë Œë“œ
        trend_data = {
            "date": pd.date_range(start="2024-01-01", end="2024-03-31", freq="W"),
            "avg_impact": [12.3, 15.7, 18.2, 14.5, 16.8, 22.1, 19.4, 17.9, 20.3, 18.7, 21.5, 23.2, 25.1]
        }
        
        fig = px.line(
            x=trend_data["date"],
            y=trend_data["avg_impact"],
            title="ì£¼ê°„ í‰ê·  ì˜í–¥ë„ íŠ¸ë Œë“œ",
            labels={"x": "ë‚ ì§œ", "y": "í‰ê·  ì˜í–¥ë„ (%)"}
        )
        fig.update_traces(line_color="blue", line_width=3)
        fig.update_layout(hovermode="x unified")
        
        st.plotly_chart(fig, use_container_width=True)
    
    with tab2:
        st.subheader("ì´ë²¤íŠ¸ë³„ ìƒì„¸ ì˜í–¥ë„ ë¶„ì„")
        
        # ì´ë²¤íŠ¸ ì„ íƒ
        event_options = ["2024 MAMA Awards", "NewJeans Comeback", "BLACKPINK Concert", "BTS Collaboration"]
        selected_event = st.selectbox("ë¶„ì„í•  ì´ë²¤íŠ¸ ì„ íƒ", event_options)
        
        if selected_event:
            # ìƒ˜í”Œ ì˜í–¥ë„ ë°ì´í„°
            impact_data = {
                "platform": ["YouTube", "Spotify", "Instagram", "Twitter", "TikTok"],
                "before_value": [1250000, 890000, 2100000, 1800000, 950000],
                "after_value": [1520000, 1150000, 2650000, 2200000, 1380000],
                "impact_percentage": [21.6, 29.2, 26.2, 22.2, 45.3]
            }
            
            # í”Œë«í¼ë³„ ì˜í–¥ë„ ì°¨íŠ¸
            fig = px.bar(
                x=impact_data["platform"],
                y=impact_data["impact_percentage"],
                title=f"{selected_event} - í”Œë«í¼ë³„ ì˜í–¥ë„",
                labels={"x": "í”Œë«í¼", "y": "ì˜í–¥ë„ (%)"},
                color=impact_data["impact_percentage"],
                color_continuous_scale="viridis"
            )
            
            st.plotly_chart(fig, use_container_width=True)
            
            # ìƒì„¸ ë°ì´í„° í…Œì´ë¸”
            st.markdown("### ğŸ“‹ ìƒì„¸ ë°ì´í„°")
            impact_df = pd.DataFrame(impact_data)
            impact_df["ë³€í™”ëŸ‰"] = impact_df["after_value"] - impact_df["before_value"]
            impact_df = impact_df.round(1)
            
            st.dataframe(impact_df, use_container_width=True)
    
    with tab3:
        st.subheader("ì˜í–¥ë„ ì¸¡ì • ê¸°ë¡ ì…ë ¥")
        
        with st.form("impact_measurement_form"):
            col1, col2 = st.columns(2)
            
            with col1:
                measure_event = st.selectbox("ì´ë²¤íŠ¸", event_options)
                measure_artist = st.selectbox("ì•„í‹°ìŠ¤íŠ¸", ["BTS", "BLACKPINK", "NewJeans", "aespa"])
                measure_platform = st.selectbox("í”Œë«í¼", ["YouTube", "Spotify", "Instagram", "Twitter", "TikTok"])
                measure_metric = st.selectbox("ì§€í‘œ", ["subscribers", "followers", "views", "plays", "likes"])
            
            with col2:
                before_value = st.number_input("ì´ë²¤íŠ¸ ì „ ê°’", min_value=0, step=1000)
                after_value = st.number_input("ì´ë²¤íŠ¸ í›„ ê°’", min_value=0, step=1000)
                measurement_period = st.number_input("ì¸¡ì • ê¸°ê°„ (ì¼)", min_value=1, max_value=30, value=7)
                confidence_level = st.slider("ì‹ ë¢° ìˆ˜ì¤€", 0.80, 0.99, 0.95, 0.01)
            
            submit_measurement = st.form_submit_button("ì˜í–¥ë„ ê¸°ë¡ ì €ì¥", type="primary")
            
            if submit_measurement:
                if before_value > 0 and after_value > 0:
                    impact_percentage = ((after_value - before_value) / before_value) * 100
                    
                    st.success(f"âœ… ì˜í–¥ë„ ì¸¡ì •ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!")
                    st.info(f"ğŸ“Š ê³„ì‚°ëœ ì˜í–¥ë„: {impact_percentage:.2f}%")
                    
                    # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
                    
                else:
                    st.error("âŒ ì¸¡ì • ê°’ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# ==================== íŒ¨í„´ ë¶„ì„ ====================
elif menu_option == "ğŸ“ˆ íŒ¨í„´ ë¶„ì„":
    st.header("ğŸ“ˆ ì´ë²¤íŠ¸ íŒ¨í„´ ë¶„ì„")
    
    tab1, tab2, tab3 = st.tabs(["ğŸ”„ ê³„ì ˆì„± ë¶„ì„", "ğŸ“Š ìƒê´€ê´€ê³„", "ğŸ”® ì˜ˆì¸¡ ëª¨ë¸"])
    
    with tab1:
        st.subheader("ê³„ì ˆì„± íŒ¨í„´ ë¶„ì„")
        
        # ê³„ì ˆë³„ ì´ë²¤íŠ¸ íš¨ê³¼ íˆíŠ¸ë§µ
        seasonal_matrix = {
            "month": ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"],
            "award_impact": [8.5, 6.2, 7.8, 9.1, 7.3, 6.9, 5.8, 7.4, 8.9, 9.6, 9.8, 8.2],
            "comeback_impact": [6.8, 5.9, 8.2, 8.7, 9.3, 8.1, 7.6, 8.4, 9.1, 8.8, 7.9, 6.4],
            "concert_impact": [7.2, 6.1, 7.9, 8.3, 8.9, 9.2, 8.7, 8.5, 8.1, 7.6, 7.3, 6.8]
        }
        
        # íˆíŠ¸ë§µ ë°ì´í„° ì¤€ë¹„
        heatmap_data = [
            seasonal_matrix["award_impact"],
            seasonal_matrix["comeback_impact"], 
            seasonal_matrix["concert_impact"]
        ]
        
        fig = go.Figure(data=go.Heatmap(
            z=heatmap_data,
            x=seasonal_matrix["month"],
            y=["ì‹œìƒì‹", "ì»´ë°±", "ì½˜ì„œíŠ¸"],
            colorscale="viridis",
            colorbar=dict(title="ì˜í–¥ë„ ì ìˆ˜")
        ))
        
        fig.update_layout(
            title="ì›”ë³„ ì´ë²¤íŠ¸ íƒ€ì…ë³„ ì˜í–¥ë„ íˆíŠ¸ë§µ",
            xaxis_title="ì›”",
            yaxis_title="ì´ë²¤íŠ¸ íƒ€ì…"
        )
        
        st.plotly_chart(fig, use_container_width=True)
        
        # ê³„ì ˆë³„ ì¸ì‚¬ì´íŠ¸
        st.markdown("### ğŸ” ê³„ì ˆë³„ ì¸ì‚¬ì´íŠ¸")
        insights = [
            "ğŸŒ¸ **ë´„ì²  (3-5ì›”)**: ì»´ë°± ì´ë²¤íŠ¸ì˜ ì˜í–¥ë„ê°€ ê°€ì¥ ë†’ìŒ",
            "â˜€ï¸ **ì—¬ë¦„ì²  (6-8ì›”)**: ì½˜ì„œíŠ¸ ì˜í–¥ë„ê°€ peak, íœ´ê°€ì²  íŠ¹ìˆ˜ íš¨ê³¼",
            "ğŸ‚ **ê°€ì„ì²  (9-11ì›”)**: ì‹œìƒì‹ ì‹œì¦Œìœ¼ë¡œ ì „ë°˜ì  ì˜í–¥ë„ ìµœê³ ì¡°",
            "â„ï¸ **ê²¨ìš¸ì²  (12-2ì›”)**: ì—°ë§ì—°ì‹œë¡œ ìƒëŒ€ì  ì˜í–¥ë„ í•˜ë½"
        ]
        
        for insight in insights:
            st.info(insight)
    
    with tab2:
        st.subheader("ì´ë²¤íŠ¸ ê°„ ìƒê´€ê´€ê³„ ë¶„ì„")
        
        # ìƒê´€ê´€ê³„ ë§¤íŠ¸ë¦­ìŠ¤ ë°ì´í„°
        correlation_data = {
            "variables": ["ì‹œìƒì‹ ì˜í–¥ë„", "ì»´ë°± ì˜í–¥ë„", "ì½˜ì„œíŠ¸ ì˜í–¥ë„", "ì†Œì…œë¯¸ë””ì–´ í™œë™", "ì–¸ë¡  ë³´ë„ëŸ‰"],
            "award": [1.00, 0.65, 0.42, 0.78, 0.84],
            "comeback": [0.65, 1.00, 0.38, 0.82, 0.71],
            "concert": [0.42, 0.38, 1.00, 0.56, 0.48],
            "social": [0.78, 0.82, 0.56, 1.00, 0.73],
            "media": [0.84, 0.71, 0.48, 0.73, 1.00]
        }
        
        # ìƒê´€ê´€ê³„ íˆíŠ¸ë§µ
        correlation_matrix = [
            correlation_data["award"],
            correlation_data["comeback"],
            correlation_data["concert"],
            correlation_data["social"],
            correlation_data["media"]
        ]
        
        fig = go.Figure(data=go.Heatmap(
            z=correlation_matrix,
            x=correlation_data["variables"],
            y=correlation_data["variables"],
            colorscale="RdBu",
            zmid=0,
            colorbar=dict(title="ìƒê´€ê³„ìˆ˜")
        ))
        
        fig.update_layout(
            title="ì´ë²¤íŠ¸ ìš”ì†Œ ê°„ ìƒê´€ê´€ê³„",
            width=600,
            height=600
        )
        
        st.plotly_chart(fig, use_container_width=True)
        
        # ì£¼ìš” ë°œê²¬ì‚¬í•­
        st.markdown("### ğŸ” ì£¼ìš” ë°œê²¬ì‚¬í•­")
        st.success("ğŸ“ˆ **ì‹œìƒì‹â†”ì–¸ë¡ ë³´ë„**: ê°€ì¥ ë†’ì€ ìƒê´€ê´€ê³„ (0.84)")
        st.info("ğŸµ **ì»´ë°±â†”ì†Œì…œë¯¸ë””ì–´**: ê°•í•œ ìƒê´€ê´€ê³„ (0.82)")
        st.warning("ğŸª **ì½˜ì„œíŠ¸â†”ê¸°íƒ€ì´ë²¤íŠ¸**: ìƒëŒ€ì ìœ¼ë¡œ ë…ë¦½ì  íŠ¹ì„±")
    
    with tab3:
        st.subheader("ì˜í–¥ë„ ì˜ˆì¸¡ ëª¨ë¸")
        
        # ì˜ˆì¸¡ ì„¤ì •
        col1, col2 = st.columns(2)
        
        with col1:
            predict_event_type = st.selectbox("ì´ë²¤íŠ¸ íƒ€ì…", ["award_ceremony", "comeback", "concert"])
            predict_month = st.selectbox("ì˜ˆìƒ ì›”", list(range(1, 13)))
            predict_artist_tier = st.selectbox("ì•„í‹°ìŠ¤íŠ¸ ë“±ê¸‰", ["Aê¸‰ (top tier)", "Bê¸‰ (mid tier)", "Cê¸‰ (rising)"])
        
        with col2:
            predict_competition = st.slider("ì˜ˆìƒ ê²½ìŸ ìˆ˜ì¤€", 1, 5, 3)
            predict_promotion_budget = st.selectbox("í”„ë¡œëª¨ì…˜ ì˜ˆì‚°", ["ì†Œê·œëª¨", "ì¤‘ê°„ê·œëª¨", "ëŒ€ê·œëª¨"])
            predict_global_trend = st.slider("ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ì ìˆ˜", 1.0, 10.0, 5.0, 0.1)
        
        if st.button("ì˜í–¥ë„ ì˜ˆì¸¡", type="primary"):
            with st.spinner("AI ëª¨ë¸ì´ ì˜í–¥ë„ë¥¼ ì˜ˆì¸¡ì¤‘ì…ë‹ˆë‹¤..."):
                # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ML ëª¨ë¸ ì‚¬ìš©
                import time
                time.sleep(2)
                
                # ìƒ˜í”Œ ì˜ˆì¸¡ ê²°ê³¼
                predicted_impact = 23.7
                confidence_interval = (18.2, 29.1)
                
                st.markdown("### ğŸ”® ì˜ˆì¸¡ ê²°ê³¼")
                
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("ì˜ˆì¸¡ ì˜í–¥ë„", f"{predicted_impact:.1f}%")
                with col2:
                    st.metric("ì‹ ë¢°êµ¬ê°„ í•˜í•œ", f"{confidence_interval[0]:.1f}%")
                with col3:
                    st.metric("ì‹ ë¢°êµ¬ê°„ ìƒí•œ", f"{confidence_interval[1]:.1f}%")
                
                # ì˜ˆì¸¡ ì •í™•ë„ ì •ë³´
                st.info("ğŸ“Š ëª¨ë¸ ì •í™•ë„: 82.4% (ìµœê·¼ 100ê±´ ê¸°ì¤€)")
                st.success("âœ… ë†’ì€ ì˜í–¥ë„ê°€ ì˜ˆìƒë©ë‹ˆë‹¤. ì „ëµì  ê¸°íšŒë¡œ í™œìš©í•˜ì„¸ìš”!")

# í‘¸í„°
st.markdown("---")
st.markdown("**ğŸ’¡ íŒ**: ì´ë²¤íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œì„ í™œìš©í•˜ì—¬ ì „ëµì ì¸ K-Pop ë§ˆì¼€íŒ… ê³„íšì„ ìˆ˜ë¦½í•˜ì„¸ìš”!")

# ì¶”ê°€ ì •ë³´
with st.expander("â„¹ï¸ ì‹œìŠ¤í…œ ì •ë³´"):
    st.markdown("""
    **K-Pop ì´ë²¤íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ** v1.0
    
    - ğŸ“… ì´ë²¤íŠ¸ ë‹¬ë ¥: ëª¨ë“  K-Pop ì´ë²¤íŠ¸ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬
    - ğŸ† ì‹œìƒì‹ ê´€ë¦¬: ì£¼ìš” ì‹œìƒì‹ ì •ë³´ì™€ ì¼ì • ì¶”ì 
    - ğŸµ ì»´ë°± ë¶„ì„: ìµœì ì˜ ì»´ë°± íƒ€ì´ë° ë¶„ì„ ë° ì¶”ì²œ
    - ğŸ“Š ì˜í–¥ë„ ë¶„ì„: ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ì˜í–¥ë„ ì¸¡ì • ë° ë¶„ì„
    - ğŸ“ˆ íŒ¨í„´ ë¶„ì„: ê³„ì ˆì„± ë° ìƒê´€ê´€ê³„ ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ì œê³µ
    
    **ê°œë°œ**: K-Pop Analytics Team | **ì—…ë°ì´íŠ¸**: 2024-09-09
    """)

{% extends "base.html" %}

{% block title %}K-POP Analytics ì£¼ê°„ ë¦¬í¬íŠ¸ - {{ period_start }} ~ {{ period_end }}{% endblock %}

{% block header %}
<h1>ğŸ“Š K-POP Analytics</h1>
<div class="subtitle">ì£¼ê°„ ì„±ê³¼ ë¦¬í¬íŠ¸ | {{ period_start }} - {{ period_end }}</div>
{% endblock %}

{% block content %}
<!-- Executive Summary -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--primary-color);">ğŸ“ˆ</span>
            ê²½ì˜ì§„ ìš”ì•½
        </h2>
    </div>
    <div class="section-content">
        {% if summary_cards %}
        <div class="metric-cards">
            {% for card in summary_cards %}
            <div class="metric-card {{ card.status|default('neutral') }}">
                <div class="metric-value">
                    {{ card.value }}{% if card.unit %} {{ card.unit }}{% endif %}
                </div>
                <div class="metric-label">{{ card.title }}</div>
                {% if card.change %}
                <div class="metric-change {{ 'positive' if card.change > 0 else 'negative' }}">
                    {{ '+' if card.change > 0 else '' }}{{ card.change|round(1) }}%
                    <small style="opacity: 0.8;">vs. ì´ì „ ì£¼</small>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Key Insights -->
        <div class="alert info">
            <strong>ğŸ¯ ì£¼ìš” ì¸ì‚¬ì´íŠ¸:</strong><br>
            â€¢ ì´ë²ˆ ì£¼ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ ì„±ì¥ë¥ ì€ ì „ì£¼ ëŒ€ë¹„ {{ portfolio_growth|default(5.2) }}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.<br>
            â€¢ ìƒìœ„ {{ top_performers|length|default(3) }}ê°œ ì•„í‹°ìŠ¤íŠ¸ê°€ ì „ì²´ ì„±ê³¼ì˜ {{ top_contribution|default(68) }}%ë¥¼ ê¸°ì—¬í–ˆìŠµë‹ˆë‹¤.<br>
            â€¢ ì†Œì…œë¯¸ë””ì–´ ì°¸ì—¬ë„ëŠ” í‰ê·  {{ engagement_rate|default(7.8) }}%ë¥¼ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.
        </div>
    </div>
</section>

<!-- Top Performers -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--success-color);">ğŸŒŸ</span>
            ì´ì£¼ì˜ ë² ìŠ¤íŠ¸ í¼í¬ë¨¸
        </h2>
    </div>
    <div class="section-content">
        {% if top_performers %}
        <div style="display: grid; gap: 20px;">
            {% for category, performers in top_performers.items() %}
            <div>
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                    {{ category|title }} ë¶€ë¬¸
                </h3>
                {% if performers %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ì•„í‹°ìŠ¤íŠ¸</th>
                            <th>ì§€í‘œê°’</th>
                            <th>ë³€í™”ìœ¨</th>
                            <th>ê°•ì </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for performer in performers[:5] %}
                        <tr>
                            <td>
                                <strong style="color: var(--primary-color);">#{{ performer.rank }}</strong>
                            </td>
                            <td>
                                <strong>{{ performer.entity_name }}</strong>
                                <br><small style="color: var(--text-secondary);">{{ performer.entity_type }}</small>
                            </td>
                            <td>
                                {{ performer.metric_value|round(1) }} {{ performer.metric_unit|default('') }}
                            </td>
                            <td>
                                {% if performer.change %}
                                <span class="metric-change {{ 'positive' if performer.change > 0 else 'negative' }}">
                                    {{ '+' if performer.change > 0 else '' }}{{ performer.change|round(1) }}%
                                </span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                <small style="color: var(--text-secondary);">
                                    {% if performer.key_strengths %}
                                    {{ performer.key_strengths[0] }}
                                    {% else %}
                                    ìš°ìˆ˜í•œ ì„±ê³¼
                                    {% endif %}
                                </small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</section>

<!-- Weekly Trends -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--accent-color);">ğŸ“Š</span>
            ì£¼ê°„ íŠ¸ë Œë“œ ë¶„ì„
        </h2>
    </div>
    <div class="section-content">
        {% if trends %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
            {% for trend_name, trend_data in trends.items() %}
            <div style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
                <h4 style="color: var(--text-primary); margin-bottom: 10px;">
                    {{ trend_name|replace('_', ' ')|title }}
                </h4>
                <div style="display: flex; justify-content: between; align-items: center;">
                    <span class="metric-change {{ 'positive' if trend_data.change_percent > 0 else 'negative' }}">
                        {{ '+' if trend_data.change_percent > 0 else '' }}{{ trend_data.change_percent }}%
                    </span>
                    <small style="color: var(--text-secondary);">
                        {{ trend_data.trend|title }}
                    </small>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Weekly Chart -->
        <div class="chart-container">
            <h4 style="margin-bottom: 15px; color: var(--text-primary);">ì£¼ê°„ ì„±ê³¼ ì¶”ì´</h4>
            <div id="weeklyTrendChart" style="height: 400px;"></div>
        </div>
    </div>
</section>

<!-- Attention Areas -->
{% if attention_items %}
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--warning-color);">âš ï¸</span>
            ì£¼ì˜ í•„ìš” ì˜ì—­
        </h2>
    </div>
    <div class="section-content">
        {% for item in attention_items %}
        <div class="alert {{ item.alert_level|default('warning') }}" style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 10px;">
                <div>
                    <strong>{{ item.entity_name }}</strong>
                    <small style="opacity: 0.8; margin-left: 10px;">({{ item.entity_type }})</small>
                </div>
                <span style="font-size: 0.8rem; font-weight: 500; padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.2);">
                    ì‹¬ê°ë„: {{ item.severity_score|round(0) }}/100
                </span>
            </div>
            <div style="margin-bottom: 10px;">
                <strong>ì´ìŠˆ:</strong> 
                {% for issue in item.issues %}
                {{ issue }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </div>
            {% if item.recommended_actions %}
            <div>
                <strong>ê¶Œì¥ì‚¬í•­:</strong>
                <ul style="margin: 5px 0 0 20px;">
                    {% for action in item.recommended_actions[:2] %}
                    <li>{{ action }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Platform Performance -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--secondary-color);">ğŸŒ</span>
            í”Œë«í¼ë³„ ì„±ê³¼
        </h2>
    </div>
    <div class="section-content">
        <div class="chart-container">
            <div id="platformPerformanceChart" style="height: 350px;"></div>
        </div>
        
        <div style="margin-top: 25px;">
            <h4 style="color: var(--text-primary); margin-bottom: 15px;">í”Œë«í¼ ìš”ì•½</h4>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>í”Œë«í¼</th>
                        <th>ì´ íŒ”ë¡œì›Œ</th>
                        <th>ì£¼ê°„ ì¦ê°€</th>
                        <th>ì°¸ì—¬ìœ¨</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody>
                    {% set platform_data = [
                        {'name': 'YouTube', 'followers': '2.8M', 'growth': '+5.2%', 'engagement': '8.1%', 'status': 'positive'},
                        {'name': 'Instagram', 'followers': '1.9M', 'growth': '+3.8%', 'engagement': '7.3%', 'status': 'positive'},
                        {'name': 'TikTok', 'followers': '3.2M', 'growth': '+8.7%', 'engagement': '12.4%', 'status': 'positive'},
                        {'name': 'Spotify', 'followers': '1.1M', 'growth': '+2.1%', 'engagement': '6.8%', 'status': 'neutral'}
                    ] %}
                    {% for platform in platform_data %}
                    <tr>
                        <td><strong>{{ platform.name }}</strong></td>
                        <td>{{ platform.followers }}</td>
                        <td>
                            <span class="metric-change {{ platform.status }}">
                                {{ platform.growth }}
                            </span>
                        </td>
                        <td>{{ platform.engagement }}</td>
                        <td>
                            <span style="color: var(--{{ platform.status == 'positive' and 'success' or 'warning' }}-color);">
                                {{ platform.status == 'positive' and 'ìš°ìˆ˜' or 'ë³´í†µ' }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Weekly Highlights -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--accent-color);">âœ¨</span>
            ì´ì£¼ì˜ í•˜ì´ë¼ì´íŠ¸
        </h2>
    </div>
    <div class="section-content">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div class="alert info">
                <strong>ğŸµ ì½˜í…ì¸  ì„±ê³¼</strong><br>
                ì‹ ê·œ ë®¤ì§ë¹„ë””ì˜¤ 2í¸ì´ 24ì‹œê°„ ë‚´ 100ë§Œ ì¡°íšŒìˆ˜ë¥¼ ëŒíŒŒí–ˆìŠµë‹ˆë‹¤.
                í‰ê·  ì°¸ì—¬ìœ¨ì€ ì „ì£¼ ëŒ€ë¹„ 15% ì¦ê°€í–ˆìŠµë‹ˆë‹¤.
            </div>
            <div class="alert info">
                <strong>ğŸŒ ê¸€ë¡œë²Œ í™•ì¥</strong><br>
                í•´ì™¸ íŒ¬ë² ì´ìŠ¤ê°€ 12% ì¦ê°€í–ˆìœ¼ë©°, íŠ¹íˆ ë™ë‚¨ì•„ì‹œì•„ ì§€ì—­ì—ì„œ
                ë†’ì€ ì„±ì¥ë¥ ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.
            </div>
            <div class="alert info">
                <strong>ğŸ“± ë””ì§€í„¸ ë§ˆì¼€íŒ…</strong><br>
                ì†Œì…œë¯¸ë””ì–´ ìº í˜ì¸ì˜ ROIê°€ ì „ì£¼ ëŒ€ë¹„ 25% ê°œì„ ë˜ì—ˆìœ¼ë©°,
                ë¸Œëœë“œ ì¸ì§€ë„ê°€ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Weekly Trend Chart
document.addEventListener('DOMContentLoaded', function() {
    // Weekly trend data
    const weeklyData = {
        x: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
        y: [85, 92, 88, 95, 102, 98, 105],
        type: 'scatter',
        mode: 'lines+markers',
        name: 'ì¼ì¼ ì„±ê³¼ ì ìˆ˜',
        line: {
            color: '#6366f1',
            width: 3
        },
        marker: {
            size: 8,
            color: '#ec4899'
        }
    };

    const weeklyLayout = {
        title: {
            text: 'ì£¼ê°„ ì„±ê³¼ ì¶”ì´',
            font: { size: 16, color: '#1f2937' }
        },
        xaxis: {
            title: 'ìš”ì¼'
        },
        yaxis: {
            title: 'ì„±ê³¼ ì ìˆ˜'
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 50, r: 30, b: 50, l: 60 }
    };

    if (document.getElementById('weeklyTrendChart')) {
        Plotly.newPlot('weeklyTrendChart', [weeklyData], weeklyLayout, {
            responsive: true,
            displayModeBar: false
        });
    }

    // Platform Performance Chart
    const platformData = [{
        x: ['YouTube', 'Instagram', 'TikTok', 'Spotify'],
        y: [28, 19, 32, 11],
        type: 'bar',
        marker: {
            color: ['#ff0000', '#e4405f', '#000000', '#1db954']
        },
        text: ['2.8M', '1.9M', '3.2M', '1.1M'],
        textposition: 'auto'
    }];

    const platformLayout = {
        title: {
            text: 'í”Œë«í¼ë³„ íŒ”ë¡œì›Œ ìˆ˜ (ë‹¨ìœ„: ë°±ë§Œ)',
            font: { size: 16, color: '#1f2937' }
        },
        yaxis: {
            title: 'íŒ”ë¡œì›Œ ìˆ˜ (ë°±ë§Œ)'
        },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 50, r: 30, b: 50, l: 60 }
    };

    if (document.getElementById('platformPerformanceChart')) {
        Plotly.newPlot('platformPerformanceChart', platformData, platformLayout, {
            responsive: true,
            displayModeBar: false
        });
    }
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}K-POP Analytics 월간 리포트 - {{ period_start.strftime('%Y년 %m월') }}{% endblock %}

{% block header %}
<h1>📈 K-POP Analytics</h1>
<div class="subtitle">월간 전략 리포트 | {{ period_start.strftime('%Y년 %m월') }}</div>
{% endblock %}

{% block content %}
<!-- Executive Dashboard -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--primary-color);">🎯</span>
            경영진 대시보드
        </h2>
    </div>
    <div class="section-content">
        {% if summary_cards %}
        <div class="metric-cards">
            {% for card in summary_cards %}
            <div class="metric-card {{ card.status|default('neutral') }}">
                <div class="metric-value">
                    {{ card.value }}{% if card.unit %} {{ card.unit }}{% endif %}
                </div>
                <div class="metric-label">{{ card.title }}</div>
                {% if card.change %}
                <div class="metric-change {{ 'positive' if card.change > 0 else 'negative' }}">
                    {{ '+' if card.change > 0 else '' }}{{ card.change|round(1) }}%
                    <small style="opacity: 0.8;">vs. 전월</small>
                </div>
                {% endif %}
                {% if card.description %}
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
                    {{ card.description }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Strategic Insights -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 25px;">
            <div class="alert info">
                <strong>🚀 성장 동력</strong><br>
                • 디지털 플랫폼 통합 수익이 전월 대비 {{ digital_revenue_growth|default(18.5) }}% 증가<br>
                • 글로벌 시장 진출로 해외 수익 {{ global_revenue_share|default(35) }}% 달성<br>
                • 신규 아티스트 런칭으로 포트폴리오 다양화 가속
            </div>
            <div class="alert warning">
                <strong>⚡ 주요 과제</strong><br>
                • 일부 아티스트의 국내 시장 점유율 하락 (-{{ domestic_decline|default(2.3) }}%)<br>
                • 마케팅 비용 대비 효율성 개선 필요<br>
                • 콘텐츠 제작 리드타임 단축 요구
            </div>
        </div>
    </div>
</section>

<!-- Monthly Performance Analysis -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--success-color);">📊</span>
            월간 성과 분석
        </h2>
    </div>
    <div class="section-content">
        <!-- Growth Analysis Chart -->
        <div class="chart-container">
            <h4 style="margin-bottom: 15px; color: var(--text-primary);">월간 성장률 추이</h4>
            <div id="monthlyGrowthChart" style="height: 400px;"></div>
        </div>

        <!-- Performance Matrix -->
        <div style="margin-top: 30px;">
            <h4 style="color: var(--text-primary); margin-bottom: 20px;">성과 매트릭스</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                {% set metrics = [
                    {'category': '수익성', 'current': 85, 'target': 90, 'status': 'good'},
                    {'category': '시장점유율', 'current': 12.8, 'target': 15.0, 'status': 'warning'},
                    {'category': '브랜드 인지도', 'current': 78, 'target': 75, 'status': 'excellent'},
                    {'category': '팬베이스 성장', 'current': 15.2, 'target': 12.0, 'status': 'excellent'}
                ] %}
                {% for metric in metrics %}
                <div style="background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">{{ metric.category }}</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">
                            {{ metric.current }}%
                        </span>
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">
                            목표: {{ metric.target }}%
                        </span>
                    </div>
                    <div style="margin-top: 10px;">
                        {% set status_colors = {'excellent': 'success', 'good': 'primary', 'warning': 'warning'} %}
                        <span style="color: var(--{{ status_colors[metric.status] }}-color); font-size: 0.85rem; font-weight: 500;">
                            {% if metric.status == 'excellent' %}✅ 목표 초과 달성
                            {% elif metric.status == 'good' %}👍 양호
                            {% else %}⚠️ 개선 필요
                            {% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<!-- Artist Portfolio Analysis -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--secondary-color);">🎤</span>
            아티스트 포트폴리오 분석
        </h2>
    </div>
    <div class="section-content">
        {% if top_performers %}
        <div style="margin-bottom: 30px;">
            <h4 style="color: var(--text-primary); margin-bottom: 15px;">이달의 스타 퍼포머</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                {% for category, performers in top_performers.items() %}
                {% if performers %}
                <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-color);">
                    <h5 style="color: var(--primary-color); margin-bottom: 15px; text-transform: capitalize;">
                        {{ category|replace('_', ' ') }} 부문
                    </h5>
                    {% for performer in performers[:3] %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; {% if not loop.last %}border-bottom: 1px solid var(--border-color);{% endif %}">
                        <div>
                            <div style="font-weight: 600;">#{{ performer.rank }} {{ performer.entity_name }}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">{{ performer.entity_type }}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: var(--primary-color);">
                                {{ performer.metric_value|round(1) }} {{ performer.metric_unit|default('') }}
                            </div>
                            {% if performer.change %}
                            <div class="metric-change {{ 'positive' if performer.change > 0 else 'negative' }}" style="font-size: 0.8rem;">
                                {{ '+' if performer.change > 0 else '' }}{{ performer.change|round(1) }}%
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Artist Performance Matrix -->
        <div class="chart-container">
            <h4 style="margin-bottom: 15px; color: var(--text-primary);">아티스트 성과 매트릭스 (성장률 vs 수익성)</h4>
            <div id="artistMatrixChart" style="height: 450px;"></div>
        </div>
    </div>
</section>

<!-- Market Analysis -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--accent-color);">🌍</span>
            시장 분석
        </h2>
    </div>
    <div class="section-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
            <!-- Geographic Performance -->
            <div>
                <h4 style="color: var(--text-primary); margin-bottom: 15px;">지역별 성과</h4>
                <div id="geographicChart" style="height: 300px;"></div>
                <div style="margin-top: 15px;">
                    {% set regions = [
                        {'name': '한국', 'share': 45, 'growth': 2.1},
                        {'name': '일본', 'share': 25, 'growth': 5.8},
                        {'name': '동남아시아', 'share': 15, 'growth': 18.2},
                        {'name': '북미', 'share': 10, 'growth': 12.5},
                        {'name': '기타', 'share': 5, 'growth': 8.7}
                    ] %}
                    <table class="data-table" style="font-size: 0.9rem;">
                        <thead>
                            <tr>
                                <th>지역</th>
                                <th>점유율</th>
                                <th>성장률</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for region in regions %}
                            <tr>
                                <td>{{ region.name }}</td>
                                <td>{{ region.share }}%</td>
                                <td class="metric-change {{ 'positive' if region.growth > 5 else 'neutral' }}">
                                    +{{ region.growth }}%
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Platform Distribution -->
            <div>
                <h4 style="color: var(--text-primary); margin-bottom: 15px;">플랫폼별 매출 구성</h4>
                <div id="platformRevenueChart" style="height: 300px;"></div>
                <div style="margin-top: 15px;">
                    <div class="alert info">
                        <strong>💡 인사이트</strong><br>
                        • 스트리밍 수익이 전체의 {{ streaming_share|default(58) }}% 차지<br>
                        • MD/굿즈 판매 {{ merch_growth|default(23) }}% 성장<br>
                        • 라이브 공연 수익 회복세 ({{ live_recovery|default(45) }}%)
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Monthly Comparisons -->
{% if monthly_comparisons %}
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--primary-color);">📈</span>
            전월 대비 분석
        </h2>
    </div>
    <div class="section-content">
        <div class="metric-cards">
            {% for comparison_name, data in monthly_comparisons.items() %}
            <div class="metric-card {{ 'positive' if data.change > 0 else 'negative' if data.change < -2 else 'neutral' }}">
                <div class="metric-value">{{ data.current|round(1) }}%</div>
                <div class="metric-label">{{ comparison_name|replace('_', ' ')|title }}</div>
                <div class="metric-change {{ 'positive' if data.change > 0 else 'negative' }}">
                    {{ '+' if data.change > 0 else '' }}{{ data.change|round(1) }}%p
                    <small style="opacity: 0.8;">전월: {{ data.previous|round(1) }}%</small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Action Items & Recommendations -->
<section class="section">
    <div class="section-header">
        <h2 class="section-title">
            <span style="color: var(--accent-color);">🎯</span>
            실행 계획 & 권장사항
        </h2>
    </div>
    <div class="section-content">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
            <div>
                <h4 style="color: var(--success-color); margin-bottom: 15px;">✅ 이번 달 성과</h4>
                <ul style="list-style-type: none; padding: 0;">
                    <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <strong>신규 아티스트 데뷔</strong> - 첫 주 차트 진입 성공
                    </li>
                    <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <strong>글로벌 투어</strong> - 12개 도시 매진 기록
                    </li>
                    <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <strong>스트리밍 기록</strong> - 월간 10억 재생 돌파
                    </li>
                    <li style="padding: 8px 0;">
                        <strong>브랜드 파트너십</strong> - 3개 메이저 브랜드 계약
                    </li>
                </ul>
            </div>

            <div>
                <h4 style="color: var(--warning-color); margin-bottom: 15px;">🎯 다음 달 목표</h4>
                <ul style="list-style-type: none; padding: 0;">
                    <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <strong>시장 점유율</strong> - 국내 15%, 해외 8% 목표
                    </li>
                    <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <strong>콘텐츠 제작</strong> - 프리미엄 콘텐츠 3편 제작
                    </li>
                    <li style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                        <strong>플랫폼 확장</strong> - 새로운 소셜 플랫폼 진출
                    </li>
                    <li style="padding: 8px 0;">
                        <strong>수익 다각화</strong> - NFT/메타버스 사업 론칭
                    </li>
                </ul>
            </div>
        </div>

        <div style="margin-top: 25px; padding: 20px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--primary-color);">
            <h4 style="color: var(--primary-color); margin-bottom: 15px;">🚀 전략적 권장사항</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                <div>
                    <strong>1. 데이터 기반 의사결정 강화</strong><br>
                    <small style="color: var(--text-secondary);">
                        AI/ML 기반 팬 행동 분석으로 콘텐츠 전략 최적화
                    </small>
                </div>
                <div>
                    <strong>2. 글로벌 시장 진출 가속화</strong><br>
                    <small style="color: var(--text-secondary);">
                        동남아시아 시장 우선 공략, 현지 파트너십 확대
                    </small>
                </div>
                <div>
                    <strong>3. 차세대 플랫폼 대응</strong><br>
                    <small style="color: var(--text-secondary);">
                        메타버스, AR/VR 콘텐츠 제작 역량 확보
                    </small>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Growth Chart
    const monthlyGrowthData = [{
        x: ['1주차', '2주차', '3주차', '4주차'],
        y: [12.5, 15.2, 18.7, 16.3],
        type: 'scatter',
        mode: 'lines+markers',
        name: '주간 성장률',
        line: { color: '#6366f1', width: 3 },
        marker: { size: 10, color: '#ec4899' }
    }, {
        x: ['1주차', '2주차', '3주차', '4주차'],
        y: [10.1, 11.8, 13.2, 12.9],
        type: 'scatter',
        mode: 'lines+markers',
        name: '업계 평균',
        line: { color: '#9ca3af', width: 2, dash: 'dash' },
        marker: { size: 8, color: '#9ca3af' }
    }];

    const monthlyGrowthLayout = {
        title: { text: '주간별 성장률 비교 (%)', font: { size: 16 } },
        xaxis: { title: '주차' },
        yaxis: { title: '성장률 (%)' },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 50, r: 30, b: 50, l: 60 }
    };

    if (document.getElementById('monthlyGrowthChart')) {
        Plotly.newPlot('monthlyGrowthChart', monthlyGrowthData, monthlyGrowthLayout, {
            responsive: true, displayModeBar: false
        });
    }

    // Artist Matrix Chart
    const artistMatrixData = [{
        x: [5.2, 12.8, 8.1, 15.3, 6.7, 18.9, 3.4, 22.1],
        y: [85, 92, 78, 96, 88, 89, 72, 94],
        mode: 'markers+text',
        type: 'scatter',
        text: ['Artist A', 'Artist B', 'Artist C', 'Artist D', 'Artist E', 'Artist F', 'Artist G', 'Artist H'],
        textposition: 'top center',
        marker: {
            size: [15, 18, 12, 20, 14, 22, 10, 25],
            color: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#6366f1', '#ec4899', '#f59e0b', '#10b981'],
            opacity: 0.7
        }
    }];

    const artistMatrixLayout = {
        title: { text: '아티스트 성과 매트릭스', font: { size: 16 } },
        xaxis: { title: '성장률 (%)' },
        yaxis: { title: '수익성 점수' },
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 50, r: 30, b: 60, l: 70 }
    };

    if (document.getElementById('artistMatrixChart')) {
        Plotly.newPlot('artistMatrixChart', artistMatrixData, artistMatrixLayout, {
            responsive: true, displayModeBar: false
        });
    }

    // Geographic Chart (Pie)
    const geographicData = [{
        values: [45, 25, 15, 10, 5],
        labels: ['한국', '일본', '동남아시아', '북미', '기타'],
        type: 'pie',
        marker: {
            colors: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#8b5cf6']
        },
        textinfo: 'label+percent',
        textposition: 'outside'
    }];

    const geographicLayout = {
        title: { text: '지역별 매출 구성', font: { size: 14 } },
        showlegend: false,
        margin: { t: 50, r: 30, b: 30, l: 30 }
    };

    if (document.getElementById('geographicChart')) {
        Plotly.newPlot('geographicChart', geographicData, geographicLayout, {
            responsive: true, displayModeBar: false
        });
    }

    // Platform Revenue Chart
    const platformRevenueData = [{
        values: [58, 22, 12, 8],
        labels: ['스트리밍', 'MD/굿즈', '라이브', '기타'],
        type: 'pie',
        hole: 0.4,
        marker: {
            colors: ['#1db954', '#ff6b6b', '#4ecdc4', '#ffa726']
        },
        textinfo: 'label+percent',
        textposition: 'outside'
    }];

    const platformRevenueLayout = {
        title: { text: '수익원별 구성', font: { size: 14 } },
        showlegend: false,
        margin: { t: 50, r: 30, b: 30, l: 30 }
    };

    if (document.getElementById('platformRevenueChart')) {
        Plotly.newPlot('platformRevenueChart', platformRevenueData, platformRevenueLayout, {
            responsive: true, displayModeBar: false
        });
    }
});
</script>
{% endblock %}